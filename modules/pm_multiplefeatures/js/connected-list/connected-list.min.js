$.fn.pmConnectedList=function(e){var t={availableListTitle:null,selectedListTitle:null,enableAddAllButton:!0,enableRemoveAllButton:!0,addAllButtonLabel:"Add all",removeAllButtonLabel:"Remove all",buttonClasses:null},l=$.extend({},t,e);return this.each(function(){function e(){$("li",d).appendTo(p),$("option",o).prop("selected",!0),d.sortable("refresh"),p.sortable("refresh"),i()}function t(){$("li",p).appendTo(d),$("option",o).prop("selected",!1),d.sortable("refresh"),p.sortable("refresh"),i()}function i(){0==$("li",d).size()?(d.addClass("empty-list"),l.enableAddAllButton&&v.prop("disabled",!0)):(d.removeClass("empty-list"),l.enableAddAllButton&&v.prop("disabled",!1)),0==$("li",p).size()?(p.addClass("empty-list"),l.enableRemoveAllButton&&f.prop("disabled",!0)):(p.removeClass("empty-list"),l.enableRemoveAllButton&&f.prop("disabled",!1))}function a(e,t){originalItem=$('option[value="'+$(e).data("val")+'"]',o),1==originalItem.size()&&(t?s(e,e):(1==$("li:last-child",p).size()?(lastItem=$("option:selected",o).last(),$("option",o).size()>1&&$(lastItem).after(originalItem)):(lastItem=$("option:first-child",o),$("option",o).size()>1&&$(lastItem).before(originalItem)),$(e).appendTo(p),d.sortable("refresh"),p.sortable("refresh")),$(originalItem).prop("selected",!0),i())}function n(e,t){originalItem=$('option[value="'+$(e).data("val")+'"]',o),1==originalItem.size()&&($("option",o).size()>1&&(1==$("li:last-child",d).size()?lastItem=$("option",o).last():lastItem=$("option:selected",o).last()),t||$(e).appendTo(d),$(originalItem,o).prop("selected",!1),d.sortable("refresh"),p.sortable("refresh"),i())}function s(e,t){if(originalItem=$('option[value="'+$(e).data("val")+'"]',o),1==originalItem.size()){if(itemValue=$(e).data("val"),prevItem=$(t).prev(),prevValue=prevItem.data("val"),"undefined"!=typeof prevValue&&itemValue!=prevValue)return referenceItem=$('option[value="'+prevValue+'"]',o),void(1==referenceItem.size()&&$(referenceItem).after(originalItem));if(nextItem=$(t).next(),nextValue=nextItem.data("val"),"undefined"!=typeof nextValue&&itemValue!=nextValue)return referenceItem=$('option[value="'+nextValue+'"]',o),void(1==referenceItem.size()&&$(referenceItem).before(originalItem))}}var o=$(this);o.prop("multiple",!0);var r=(Math.random()+"").replace("0.",""),p=$("<ul />").attr("id","selected-list-"+r),d=$("<ul />").attr("id","available-list-"+r);$("option",o).each(function(){listItem=$("<li />").html($(this).html()).data("val",$(this).val()),$(this).is(":selected")?p.append(listItem):$(this).attr("selected")?(p.append(listItem),$(this).prop("selected",!0)):d.append(listItem)});var c=$('<div class="connected-list-container" />'),u=$('<div class="available-list-container" />'),m=$('<div class="selected-list-container" />');if(null!=l.availableListTitle&&u.append('<span class="list-title">'+l.availableListTitle+"</span>"),null!=l.selectedListTitle&&m.append('<span class="list-title">'+l.selectedListTitle+"</span>"),u.append(d),m.append(p),d.on("click","li",function(e){a(this,!1)}),p.on("click","li",function(){n(this,!1)}),l.enableAddAllButton){$availablelistActionsContainer=$('<div class="list-actions-container" />');var v=$("<button />").text(l.addAllButtonLabel).appendTo($availablelistActionsContainer);l.buttonClasses&&v.addClass(l.buttonClasses),v.on("click",function(t){t.preventDefault(),e()}),u.append($availablelistActionsContainer)}if(l.enableRemoveAllButton){$selectedlistActionsContainer=$('<div class="list-actions-container" />');var f=$("<button />").text(l.removeAllButtonLabel).appendTo($selectedlistActionsContainer);l.buttonClasses&&f.addClass(l.buttonClasses),f.on("click",function(e){e.preventDefault(),t()}),m.append($selectedlistActionsContainer)}c.append(u),c.append(m),o.hide(),c.insertAfter(o),$("#available-list-"+r).sortable({connectWith:"#selected-list-"+r,receive:function(e,t){n(t.item,!0)},helper:"clone",opacity:.2}),$("#selected-list-"+r).sortable({connectWith:"#available-list-"+r,receive:function(e,t){a(t.item,!0)},change:function(e,t){s(t.item,t.placeholder)},helper:"clone",opacity:.2}),i()})};